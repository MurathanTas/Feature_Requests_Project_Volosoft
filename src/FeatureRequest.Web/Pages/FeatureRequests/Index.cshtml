@page
@using FeatureRequest.Web.Pages.FeatureRequests
@using FeatureRequest.FeatureRequests
@using FeatureRequest.Permissions
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.Users
@inject ICurrentUser CurrentUser
@inject IAuthorizationService AuthorizationService
@model IndexModel
@{
    ViewData["Title"] = "Özellik İstekleri";
}

<abp-card>
    <abp-card-header>
        <abp-row>
            <abp-column size-md="_6">
                <abp-card-title>🚀 Özellik İstekleri</abp-card-title>
            </abp-column>
            <abp-column size-md="_6" class="text-end">
                @if (await AuthorizationService.IsGrantedAsync(FeatureRequestPermissions.FeatureRequests.Create))
                {
                    <a href="/FeatureRequests/Create" class="btn btn-primary">
                        <i class="fa fa-plus"></i> Yeni İstek Oluştur
                    </a>
                }
                else if (!CurrentUser.IsAuthenticated)
                {
                    <a href="/Account/Login" class="btn btn-outline-primary">
                        <i class="fa fa-sign-in-alt"></i> Giriş Yap
                    </a>
                }
            </abp-column>
        </abp-row>
        <abp-row class="mt-3">
            <abp-column size-md="_6">
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0 fw-bold">Kategori:</label>
                    <select id="categoryFilter" class="form-select form-select-sm" style="width: auto;">
                        <option value="">Tümü</option>
                        @foreach (var category in Enum.GetValues<FeatureRequestCategory>())
                        {
                            <option value="@category" selected="@(Model.SelectedCategory == category)">@category</option>
                        }
                    </select>
                </div>
            </abp-column>
            <abp-column size-md="_6" class="text-end">
                <div class="d-flex align-items-center gap-2 justify-content-end">
                    <label class="mb-0 fw-bold">Sayfa başına:</label>
                    <select id="pageSizeFilter" class="form-select form-select-sm" style="width: auto;">
                        @foreach (var size in new[] { 5, 10, 20, 50 })
                        {
                            <option value="@size" selected="@(Model.PageSize == size)">@size</option>
                        }
                    </select>
                </div>
            </abp-column>
        </abp-row>
    </abp-card-header>
    <abp-card-body>
        @if (Model.RequestList != null && Model.RequestList.Any())
        {
            <div id="RequestListContainer" class="list-group">
                @foreach (var item in Model.RequestList)
                {
                    <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 border rounded shadow-sm p-3" data-votes="@item.VoteCount">
                        <abp-row>
                            <abp-column size-md="_8">
                                <a href="/FeatureRequests/Detail?id=@item.Id" class="text-decoration-none">
                                    <h5 class="mb-1 fw-bold text-primary">@item.Title</h5>
                                </a>
                            </abp-column>
                            <abp-column size-md="_4" class="text-end">
                                <small class="text-muted">@item.CreationTime.ToShortDateString()</small>
                            </abp-column>
                        </abp-row>

                        <a href="/FeatureRequests/Detail?id=@item.Id" class="text-decoration-none text-secondary">
                            <p class="mb-1">@item.Description</p>
                        </a>

                        <abp-row class="mt-3">
                            <abp-column size-md="_6">
                                <span class="badge bg-info text-dark me-1">@item.CategoryId</span>
                                <span class="badge bg-secondary">@item.Status</span>
                            </abp-column>
                            <abp-column size-md="_6" class="text-end">
                                @{
                                    var isVotingClosed = item.Status == FeatureRequestStatus.Approved ||
                                                         item.Status == FeatureRequestStatus.Completed || 
                                                         item.Status == FeatureRequestStatus.Rejected;
                                }

                                @if (isVotingClosed)
                                {
                                    <span class="badge bg-secondary fw-bold" style="min-width: 90px;">
                                        <i class="fa fa-lock"></i> @item.VoteCount Oy
                                    </span>
                                }
                                else if (CurrentUser.IsAuthenticated)
                                {
                                    <button class="btn btn-sm fw-bold upvote-btn @(item.IsVoted ? "btn-success" : "btn-outline-success")" 
                                            data-id="@item.Id" 
                                            data-voted="@item.IsVoted.ToString().ToLower()"
                                            style="min-width: 90px;">
                                        <i class="fa @(item.IsVoted ? "fa-check" : "fa-arrow-up")"></i>
                                        <span class="vote-count">@item.VoteCount</span> Oy
                                    </button>
                                }
                                else
                                {
                                    <a href="/Account/Login" class="btn btn-sm btn-outline-secondary fw-bold" style="min-width: 90px;">
                                        <i class="fa fa-arrow-up"></i> @item.VoteCount Oy
                                    </a>
                                }
                            </abp-column>
                        </abp-row>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center">
                Henüz hiç özellik isteği yok. İlkini sen ekle!
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="?CurrentPage=@(Model.CurrentPage - 1)&PageSize=@Model.PageSize@(Model.SelectedCategory.HasValue ? "&SelectedCategory=" + Model.SelectedCategory : "")">
                            <i class="fa fa-chevron-left"></i>
                        </a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="?CurrentPage=@i&PageSize=@Model.PageSize@(Model.SelectedCategory.HasValue ? "&SelectedCategory=" + Model.SelectedCategory : "")">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="?CurrentPage=@(Model.CurrentPage + 1)&PageSize=@Model.PageSize@(Model.SelectedCategory.HasValue ? "&SelectedCategory=" + Model.SelectedCategory : "")">
                            <i class="fa fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
                <p class="text-center text-muted">Toplam @Model.TotalCount istek</p>
            </nav>
        }
    </abp-card-body>
</abp-card>

@section scripts {
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@@formkit/auto-animate/index.mjs';
        const list = document.getElementById('RequestListContainer');
        if (list) {
            autoAnimate(list);
        }
    </script>
    <abp-script src="/Pages/FeatureRequests/Index.js" />
}