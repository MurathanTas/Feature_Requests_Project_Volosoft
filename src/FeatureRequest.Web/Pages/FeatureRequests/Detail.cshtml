@page
@using Volo.Abp.Users
@using FeatureRequest.FeatureRequests
@using FeatureRequest.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@inject ICurrentUser CurrentUser
@inject IHtmlLocalizer<FeatureRequestResource> L
@model FeatureRequest.Web.Pages.FeatureRequests.DetailModel
@{
    ViewData["Title"] = Model.RequestDetail?.Title;
}

@if (Model.RequestDetail != null)
{
    <abp-row class="mb-3">
        <abp-column size-md="_6">
            <a href="/FeatureRequests" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i> @L["DetailPage:BackToList"]
            </a>
        </abp-column>
        <abp-column size-md="_6" class="text-end">
            @if (CurrentUser.IsAuthenticated && CurrentUser.Id == Model.RequestDetail.CreatorId)
            {
                <a href="/FeatureRequests/Edit?id=@Model.RequestDetail.Id" class="btn btn-warning shadow-sm">
                    <i class="fa fa-edit"></i> @L["DetailPage:Edit"]
                </a>
            }
        </abp-column>
    </abp-row>

    <abp-card class="shadow-lg border-0">
        <abp-card-header class="bg-light">
            <abp-row>
                <abp-column size-md="_6">
                    <span class="badge bg-info text-dark fs-6">@Model.RequestDetail.CategoryId</span>
                </abp-column>
                <abp-column size-md="_6" class="text-end">
                    <span class="badge bg-secondary fs-6">@Model.RequestDetail.Status</span>
                </abp-column>
            </abp-row>
        </abp-card-header>

        <abp-card-body class="p-4">
            <h2 class="card-title text-primary mb-3 fw-bold">@Model.RequestDetail.Title</h2>
            <hr />
            <p class="card-text fs-5 text-dark" style="white-space: pre-wrap; line-height: 1.6;">@Model.RequestDetail.Description</p>

            <div class="mt-4 p-3 bg-light rounded border">
                <abp-row class="text-muted small">
                    <abp-column size-md="_6">
                        <i class="fa fa-user me-1"></i> @L["DetailPage:CreatedBy"]
                        <strong>@(string.IsNullOrEmpty(Model.RequestDetail.CreatorUserName) ? L["DetailPage:Anonymous"].Value : Model.RequestDetail.CreatorUserName)</strong>
                    </abp-column>
                    <abp-column size-md="_6" class="text-md-end">
                        <i class="fa fa-calendar me-1"></i> @L["DetailPage:Date"] @Model.RequestDetail.CreationTime.ToString("f")
                    </abp-column>
                </abp-row>
            </div>
        </abp-card-body>

        <abp-card-footer class="text-center py-4 bg-white border-top-0">
            @{
                var isVotingClosed = Model.RequestDetail.Status == FeatureRequestStatus.Approved ||
                                     Model.RequestDetail.Status == FeatureRequestStatus.Completed || 
                                     Model.RequestDetail.Status == FeatureRequestStatus.Rejected;
            }
            
            @if (isVotingClosed)
            {
                <div class="text-muted">
                    <i class="fa fa-lock"></i> @L["DetailPage:VotingClosed"]
                    <br/>
                    <span class="badge bg-secondary fs-6 mt-2">@Model.RequestDetail.VoteCount @L["DetailPage:VoteCount"]</span>
                </div>
            }
            else if (CurrentUser.IsAuthenticated)
            {
                <button id="voteButton"
                        data-id="@Model.RequestDetail.Id"
                        data-voted="@Model.RequestDetail.IsVoted.ToString().ToLower()"
                        class="btn btn-lg px-5 shadow transition-btn @(Model.RequestDetail.IsVoted ? "btn-success" : "btn-outline-success")"
                        style="min-width: 200px;">
                    <i class="fa @(Model.RequestDetail.IsVoted ? "fa-check" : "fa-arrow-up")"></i>
                    <span id="voteText">@(Model.RequestDetail.IsVoted ? L["DetailPage:Voted"].Value : L["DetailPage:Vote"].Value)</span>
                    (<span id="VoteCount">@Model.RequestDetail.VoteCount</span>)
                </button>

                <div class="mt-2 text-muted small fst-italic" id="voteHelpText">
                    @(Model.RequestDetail.IsVoted ? L["DetailPage:VoteHelpVoted"] : L["DetailPage:VoteHelpNotVoted"])
                </div>
            }
            else
            {
                <a href="/Account/Login" class="btn btn-outline-primary btn-lg px-5 shadow">
                    <i class="fa fa-lock"></i> @L["DetailPage:LoginToVote"]
                </a>
            }
        </abp-card-footer>
    </abp-card>
}
else
{
    <abp-row>
        <abp-column>
            <div class="alert alert-danger shadow-sm">
                <i class="fa fa-exclamation-triangle"></i> @L["DetailPage:NotFound"]
            </div>
        </abp-column>
    </abp-row>
}

<abp-row class="mt-4 mb-5">
    <abp-column>
        <h3 class="mb-3">@string.Format(L["DetailPage:CommentsTitle"].Value, Model.Comments?.Count ?? 0)</h3>

        @if (CurrentUser.IsAuthenticated)
        {
            <abp-card class="mb-4 shadow-sm">
                <abp-card-body>
                    <div id="commentForm">
                        <input type="hidden" id="featureRequestId" value="@Model.RequestDetail.Id" />
                        <div class="mb-3">
                            <label class="form-label fw-bold">@L["DetailPage:ShareThoughts"]</label>
                            <textarea id="commentText" class="form-control" rows="3" placeholder="@L["DetailPage:CommentPlaceholder"]"></textarea>
                            <span id="commentError" class="text-danger"></span>
                        </div>
                        <abp-button id="submitCommentBtn" 
                                    button-type="Primary" 
                                    text="@L["DetailPage:Submit"].Value"
                                    icon="paper-plane" />
                    </div>
                </abp-card-body>
            </abp-card>
        }
        else
        {
            <div class="alert alert-warning">
                @Html.Raw(string.Format(L["DetailPage:LoginToComment"].Value, "<a href='/Account/Login' class='alert-link'>", "</a>"))
            </div>
        }

        <div id="commentsContainer" class="list-group">
            @if (Model.Comments != null && Model.Comments.Any())
            {
                @foreach (var comment in Model.Comments)
                {
                    <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded bg-white">
                        <abp-row>
                            <abp-column size-md="_8">
                                <h6 class="mb-1 fw-bold text-primary">
                                    <i class="fa fa-user-circle"></i> @comment.CreatorUserName
                                </h6>
                            </abp-column>
                            <abp-column size-md="_4" class="text-end">
                                <small class="text-muted">@comment.CreationTime.ToString("g")</small>
                            </abp-column>
                        </abp-row>
                        <p class="mb-1 text-dark mt-2">@comment.CommentText</p>
                    </div>
                }
            }
        </div>
        
        <p id="noCommentsText" class="text-muted text-center py-4" style="display: @(Model.Comments == null || !Model.Comments.Any() ? "block" : "none");">
            @L["DetailPage:NoComments"]
        </p>
    </abp-column>
</abp-row>

@section scripts {
    <abp-script src="/Pages/FeatureRequests/Detail.js" />
    
    <style>
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
}