@page
@using FeatureRequest.FeatureRequests
@using FeatureRequest.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Text.Json
@inject IHtmlLocalizer<FeatureRequestResource> L
@model FeatureRequest.Web.Pages.FeatureRequests.DashboardModel
@{
    ViewData["Title"] = L["DashboardPage:Title"];
}

<abp-card>
    <abp-card-header>
        <abp-card-title>@L["DashboardPage:Header"]</abp-card-title>
    </abp-card-header>
</abp-card>

<abp-row class="mt-4">
    <abp-column size-md="_3">
        <abp-card class="bg-primary text-white shadow">
            <abp-card-body class="text-center">
                <h2 class="display-4 fw-bold">@Model.Statistics.TotalRequests</h2>
                <p class="mb-0"><i class="fa fa-lightbulb"></i> @L["DashboardPage:TotalRequests"]</p>
            </abp-card-body>
        </abp-card>
    </abp-column>
    <abp-column size-md="_3">
        <abp-card class="bg-success text-white shadow">
            <abp-card-body class="text-center">
                <h2 class="display-4 fw-bold">@Model.Statistics.TotalVotes</h2>
                <p class="mb-0"><i class="fa fa-arrow-up"></i> @L["DashboardPage:TotalVotes"]</p>
            </abp-card-body>
        </abp-card>
    </abp-column>
    <abp-column size-md="_3">
        <abp-card class="bg-info text-white shadow">
            <abp-card-body class="text-center">
                <h2 class="display-4 fw-bold">@Model.Statistics.TotalComments</h2>
                <p class="mb-0"><i class="fa fa-comment"></i> @L["DashboardPage:TotalComments"]</p>
            </abp-card-body>
        </abp-card>
    </abp-column>
    <abp-column size-md="_3">
        <abp-card class="bg-warning text-dark shadow">
            <abp-card-body class="text-center">
                @{
                    var avgVotes = Model.Statistics.TotalRequests > 0 
                        ? (double)Model.Statistics.TotalVotes / Model.Statistics.TotalRequests 
                        : 0;
                }
                <h2 class="display-4 fw-bold">@avgVotes.ToString("F1")</h2>
                <p class="mb-0"><i class="fa fa-chart-line"></i> @L["DashboardPage:AverageVotes"]</p>
            </abp-card-body>
        </abp-card>
    </abp-column>
</abp-row>

<abp-row class="mt-4">
    <abp-column size-md="_6">
        <abp-card class="shadow">
            <abp-card-header>
                <abp-card-title><i class="fa fa-folder"></i> @L["DashboardPage:RequestsByCategory"]</abp-card-title>
            </abp-card-header>
            <abp-card-body>
                <canvas id="categoryChart" height="250"></canvas>
            </abp-card-body>
        </abp-card>
    </abp-column>
    <abp-column size-md="_6">
        <abp-card class="shadow">
            <abp-card-header>
                <abp-card-title><i class="fa fa-tasks"></i> @L["DashboardPage:DistributionByStatus"]</abp-card-title>
            </abp-card-header>
            <abp-card-body>
                <canvas id="statusChart" height="250"></canvas>
            </abp-card-body>
        </abp-card>
    </abp-column>
</abp-row>

<abp-row class="mt-4 mb-4">
    <abp-column size-md="_6">
        <abp-card class="shadow">
            <abp-card-header>
                <abp-card-title><i class="fa fa-star"></i> @L["DashboardPage:VotesByCategory"]</abp-card-title>
            </abp-card-header>
            <abp-card-body>
                <canvas id="categoryVotesChart" height="250"></canvas>
            </abp-card-body>
        </abp-card>
    </abp-column>
    <abp-column size-md="_6">
        <abp-card class="shadow">
            <abp-card-header>
                <abp-card-title><i class="fa fa-trophy"></i> @L["DashboardPage:TopVoted"]</abp-card-title>
            </abp-card-header>
            <abp-card-body>
                @if (Model.Statistics.TopVotedRequests.Any())
                {
                    <abp-table striped-rows="true">
                        <thead>
                            <tr>
                                <th>@L["DashboardPage:TableTitle"]</th>
                                <th>@L["DashboardPage:TableCategory"]</th>
                                <th>@L["DashboardPage:TableVote"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Statistics.TopVotedRequests)
                            {
                                <tr>
                                    <td>
                                        <a href="/FeatureRequests/Detail?id=@item.Id">@item.Title</a>
                                    </td>
                                    <td><span class="badge bg-info text-dark">@item.CategoryId</span></td>
                                    <td><strong>@item.VoteCount</strong></td>
                                </tr>
                            }
                        </tbody>
                    </abp-table>
                }
                else
                {
                    <p class="text-muted text-center">@L["DashboardPage:NoData"]</p>
                }
            </abp-card-body>
        </abp-card>
    </abp-column>
</abp-row>
@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(function () {
            var categoryLabels = @Html.Raw(JsonSerializer.Serialize(Model.Statistics.CategoryStats.Select(x => x.Category)));
            var categoryData = @Html.Raw(JsonSerializer.Serialize(Model.Statistics.CategoryStats.Select(x => x.RequestCount)));
            var categoryVotes = @Html.Raw(JsonSerializer.Serialize(Model.Statistics.CategoryStats.Select(x => x.TotalVotes)));
            var statusLabels = @Html.Raw(JsonSerializer.Serialize(Model.Statistics.StatusStats.Select(x => x.Status)));
            var statusData = @Html.Raw(JsonSerializer.Serialize(Model.Statistics.StatusStats.Select(x => x.Count)));

            var colors = [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ];

            new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: '@L["DashboardPage:ChartRequestCount"]',
                        data: categoryData,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{ data: statusData, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });

            new Chart(document.getElementById('categoryVotesChart'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: '@L["DashboardPage:ChartTotalVotes"]',
                        data: categoryVotes,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        });
    </script>
}

